% script to calculate the second order derivatives of the state and costate
% dynamics for the discrete trapezoidal rule three body dynamics
% 26 Mar 2015
function [dfdx, dfdh, dgdx, dgdh, state_eom, costate_eom] = pcrtbp_trap_lin(state,costate,h,constants)
mu = constants.mu;

%% define current state and costate at step k
xk = state(1);
yk = state(2);
xdk = state(3);
ydk = state(4);

hxk = costate(1);
hyk = costate(2);
hxdk = costate(3);
hydk = costate(4);

% define control in terms of costate
switch constants.control_switch
    case 'off'
        um = zeros(2,1);
    case 'on'
        % express control vector in terms of costates
        hv = [hxdk hydk];
        um = constants.um;
        u = -um*hv/norm(hv);
    case 'sub'
        rand_vec = constants.sub_opt;
        u = constants.um*rand_vec/norm(rand_vec);
end

h2 = h*h;
h3 = h*h*h;

r1k = sqrt((xk+mu)^2 + yk^2 );
r2k = sqrt( (xk+mu-1)^2+ yk^2 );

r1k_3 = r1k*r1k*r1k;
r2k_3 = r2k*r2k*r2k;

r1k_5 = r1k_3*r1k*r1k;
r2k_5 = r2k_3*r2k*r2k;

r1k_7 = r1k_5*r1k*r1k;
r2k_7 = r2k_5*r2k*r2k;

%% calculate the f_jacobian
uxk = ((1-mu)*(xk+mu))/(r1k_3) + mu*(xk+mu-1)/(r2k_3);
uyk =(1-mu)*yk/r1k_3  + mu *yk/r2k_3;

xkp = 1/(1+h2) *(h*xdk -h*yk +h2*ydk + h2*xk + xk*(1+h2/2) + yk*(h+1/2*h3) ...
    -1/2*h3*uyk -1/2*h2*uxk);
ykp = h*ydk + h*xk-h*xkp + yk + 1/2*h2*yk-h2/2*uyk;


r1kp = sqrt((xkp+mu)^2 + (ykp)^2);
r2kp = sqrt((xkp-1+mu)^2 + (ykp)^2);

r1kp_3 = r1kp*r1kp*r1kp;
r2kp_3 = r2kp*r2kp*r2kp;

r1kp_5 = r1kp_3*r1kp*r1kp;
r2kp_5 = r2kp_3*r2kp*r2kp;

uxkp = ((1-mu)*(xkp+mu))/(r1kp_3) + mu*(xkp+mu-1)/(r2kp_3);
uykp =(1-mu)*ykp/r1kp_3  + mu *ykp/r2kp_3;

xdkp = xdk - 2*yk + 2*ykp + h/2*(xkp + xk) - h/2*uxkp - h/2*uxk + h*u(1);
ydkp = ydk + 2*xk - 2*xkp + h/2*(ykp + yk) - h/2*uykp - h/2*uyk + h*u(2);

state_eom = [xkp;ykp;xdkp;ydkp];
% calculate the f_jacobian
% second order partials at step k
Uxxk =  (1-mu) * ( 1/r1k_3 - ( 3*((xk + mu)^2)/r1k_5 ) ) + mu * (1/r2k_3 - 3*(xk - 1 + mu)^2 /r2k_5);
Uyyk = (1-mu) * ( 1/r1k_3 -  3*yk^2/r1k_5 ) + mu * ( 1/r2k_3 -3*yk^2/r2k_5);
Uxyk = -3*(1-mu)*yk*(xk+mu)/r1k_5 - 3*mu*yk*(xk-1+mu)/r2k_5; Uyxk = Uxyk;

f_jacobian = zeros(4,4);

f_jacobian(1,1) = 1/(1+h2) *( h2 + 1 + 1/2*h2 -1/2*h3 * Uyxk - 1/2*h2 * Uxxk);
f_jacobian(1,2) = 1/(1+h2) *(-h + h +h3/2 - h3/2*Uyyk - h2/2 * Uxyk );
f_jacobian(1,3) = h/(1+h2);
f_jacobian(1,4) = h2/(1+h2);

f_jacobian(2,1) = h - h*f_jacobian(1,1) - h2/2 * Uyxk;
f_jacobian(2,2) = -h*f_jacobian(1,2) + 1 + h2/2 -h2/2*Uyyk;
f_jacobian(2,3) = -h*f_jacobian(1,3);
f_jacobian(2,4) = h - h*f_jacobian(1,4);

% partials of potential at k+1

r1kp_partial = zeros(1,4);
r1kp_partial(1) =  ((xkp + mu) * f_jacobian(1,1) + ykp*f_jacobian(2,1));
r1kp_partial(2) =  ((xkp + mu) * f_jacobian(1,2) + ykp*f_jacobian(2,2));
r1kp_partial(3) =  ((xkp + mu) * f_jacobian(1,3) + ykp*f_jacobian(2,3));
r1kp_partial(4) =  ((xkp + mu) * f_jacobian(1,4) + ykp*f_jacobian(2,4));

r2kp_partial = zeros(1,4);
r2kp_partial(1) = ((xkp - 1 + mu) * f_jacobian(1,1) + ykp*f_jacobian(2,1));
r2kp_partial(2) = ((xkp - 1 + mu) * f_jacobian(1,2) + ykp*f_jacobian(2,2));
r2kp_partial(3) = ((xkp - 1 + mu) * f_jacobian(1,3) + ykp*f_jacobian(2,3));
r2kp_partial(4) = ((xkp - 1 + mu) * f_jacobian(1,4) + ykp*f_jacobian(2,4));

Uxxkp =  (1-mu) * (f_jacobian(1,1)/r1kp_3  - ( 3*((xkp + mu))/r1kp_5 ) * r1kp_partial(1) ) ...
    + mu * (f_jacobian(1,1)/r2kp_3 - (3*(xkp - 1 + mu)/r2kp_5) * r2kp_partial(1));
Uxykp =  (1-mu) * (f_jacobian(1,2)/r1kp_3  - ( 3*((xkp + mu))/r1kp_5 ) * r1kp_partial(2) ) ...
    + mu * (f_jacobian(1,2)/r2kp_3 - 3*(xkp - 1 + mu)/r2kp_5 * r2kp_partial(2));
Uxxdkp = (1-mu) * (f_jacobian(1,3)/r1kp_3 - ( 3*((xkp + mu))/r1kp_5 ) * r1kp_partial(3) ) ...
    + mu * (f_jacobian(1,3)/r2kp_3 - (3*(xkp - 1 + mu)/r2kp_5) * r2kp_partial(3));
Uxydkp = (1-mu) * (f_jacobian(1,4)/r1kp_3 - ( 3*((xkp + mu))/r1kp_5 ) * r1kp_partial(4) ) ...
    + mu * (f_jacobian(1,4)/r2kp_3 - 3*(xkp - 1 + mu)/r2kp_5 * r2kp_partial(4));

Uyxkp = (1-mu) * (f_jacobian(2,1)/r1kp_3 -  3*ykp/r1kp_5 *r1kp_partial(1) ) ...
    + mu * ( f_jacobian(2,1)/r2kp_3 -3*ykp/r2kp_5 * r2kp_partial(2));
Uyykp = (1-mu) * (f_jacobian(2,2)/r1kp_3 -  3*ykp/r1kp_5 *r1kp_partial(2) ) ...
    + mu * (f_jacobian(2,2)/r2kp_3 -3*ykp/r2kp_5 * r2kp_partial(2));
Uyxdkp = (1-mu) * (f_jacobian(2,3)/r1kp_3 -  3*ykp/r1kp_5 *r1kp_partial(3) ) ...
    + mu * (f_jacobian(2,3)/r2kp_3 -3*ykp/r2kp_5 * r2kp_partial(3));
Uyydkp = (1-mu) * (f_jacobian(2,4)/r1kp_3 -  3*ykp/r1kp_5 *r1kp_partial(4) ) ...
    + mu * (f_jacobian(2,4)/r2kp_3 -3*ykp/r2kp_5 * r2kp_partial(4));

% f_jacobian of velocity
f_jacobian(3,1) = 2*f_jacobian(2,1) + h/2*(f_jacobian(1,1) + 1) - h/2*Uxxkp - h/2 * Uxxk;
f_jacobian(3,2) = -2+ 2* f_jacobian(2,2) + h/2*f_jacobian(1,2) - h/2 * Uxykp - h/2 * Uxyk;
f_jacobian(3,3) = 1+2*f_jacobian(2,3) + h/2*f_jacobian(1,3) - h/2*Uxxdkp;
f_jacobian(3,4) = 2*f_jacobian(2,4) + h/2*f_jacobian(1,4) - h/2*Uxydkp;

f_jacobian(4,1) = 2 - 2 * f_jacobian(1,1) + h/2*f_jacobian(2,1) -h/2*Uyxkp - h/2 * Uyxk;
f_jacobian(4,2) = -2*f_jacobian(1,2) + h/2*(f_jacobian(2,2)+1) - h/2*Uyykp - h/2*Uyyk;
f_jacobian(4,3) = -2*f_jacobian(1,3) + h/2 *f_jacobian(2,3) - h/2*Uyxdkp;
f_jacobian(4,4) = 1 -2*f_jacobian(1,4) + h/2*f_jacobian(2,4) - h/2 * Uyydkp;

dfdx = f_jacobian;

% solve for costates
% transpose the f_jacobian for column multiplication
J = f_jacobian';

f1x = J(1,1);
f2x = J(1,2);
f3x = J(1,3);
f4x = J(1,4);

f1y = J(2,1);
f2y = J(2,2);
f3y = J(2,3);
f4y = J(2,4);

f1xd = J(3,1);
f2xd = J(3,2);
f3xd = J(3,3);
f4xd = J(3,4);

f1yd = J(4,1);
f2yd = J(4,2);
f3yd = J(4,3);
f4yd = J(4,4);

a = -f1y/f1x; b = -f1xd/f1x; c = -f1yd/f1x;
e = -(f2xd+b*f2x)/(f2y+a*f2x);
f = -(f2yd+c*f2x)/(f2y+a*f2x);
g = - (f3yd + c*f3x + f*(f3y + a*f3x))/(f3xd + b*f3x + e*(f3y + a*f3x));

a11 = f1x; a12 = f2x; a13 = f3x; a14 = f4x;
a22 = f2y + a*f2x; a23 = f3y + a*f3x; a24 = f4y + a*f4x;
a33 = f3xd + b*f3x + e*(f3y+a*f3x); a34 = f4xd + b*f4x + e*(f4y + a*f4x);
a44 = f4yd + c*f4x + f*(f4y + a*f4x) + g*(f4xd + b*f4x + e*(f4y + a*f4x));

beta1 = hxk;
beta2 = hyk + a*hxk;
beta3 = hxdk + b*hxk + e*(hyk + a*hxk);
beta4 = hydk + c*hxk + f*(hyk + a*hxk) + g*(hxdk + b* hxk + e*(hyk + a*hxk));

g4 = beta4/a44;
g3 = beta3/a33 - a34/a33*g4;
g2 = beta2/a22 - a23/a22*g3 - a24/a22*g4;
g1 = beta1/a11 - a12/a11*g2 - a13/a11*g3 - a14/a11*g4;

costate_eom = [g1;g2;g3;g4];
%% Gradient of the graviational potentials (third order)


Uxk_mat = ...
    [                                              (3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2),                                                  (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2), 0, 0;...
    (yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)), ((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2), 0, 0;...
    0,                                                                                                                                                                                                                              0, 0, 0;...
    0,                                                                                                                                                                                                                              0, 0, 0];

Uyk_mat = ...
    [ (yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)), ((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2), 0, 0;...
    (3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2),                                              (3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2), 0, 0;...
    0,                                                                                                                                                                                                                              0, 0, 0;...
    0,                                                                                                                                                                                                                              0, 0, 0];

Uxkp_mat = ...
    [ mu*(((ykp*((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h^2*((3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + (((h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h^2*((3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2)))/2)*(mu + xkp - 1))/(h^2 + 1))*(3*mu + 3*xkp - 3))/((mu + xkp - 1)^2 + ykp^2)^(5/2) - ((h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h^2*((3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2)))/2)/((h^2 + 1)*((mu + xkp - 1)^2 + ykp^2)^(3/2))) - (mu - 1)*(((3*mu + 3*xkp)*(ykp*((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h^2*((3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + ((mu + xkp)*((h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h^2*((3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2) - ((h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h^2*((3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2)))/2)/((h^2 + 1)*((mu + xkp)^2 + ykp^2)^(3/2))), mu*(((ykp*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 + (h*((h^2*((3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) - (((h^2*((3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)*(mu + xkp - 1))/(h^2 + 1))*(3*mu + 3*xkp - 3))/((mu + xkp - 1)^2 + ykp^2)^(5/2) + ((h^2*((3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)/((h^2 + 1)*((mu + xkp - 1)^2 + ykp^2)^(3/2))) - (((3*mu + 3*xkp)*(ykp*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 + (h*((h^2*((3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) - ((mu + xkp)*((h^2*((3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2) + ((h^2*((3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)/((h^2 + 1)*((mu + xkp)^2 + ykp^2)^(3/2)))*(mu - 1), 0, 0;...
    mu*(((ykp*((h^2*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) + (((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp - 1))/(h^2 + 1))*(3*mu + 3*xkp - 3))/((mu + xkp - 1)^2 + ykp^2)^(5/2) - ((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)/((h^2 + 1)*((mu + xkp - 1)^2 + ykp^2)^(3/2))) - (mu - 1)*(((3*mu + 3*xkp)*(ykp*((h^2*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) + (((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2) - ((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)/((h^2 + 1)*((mu + xkp)^2 + ykp^2)^(3/2))),                                                                   (((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)/((h^2 + 1)*((mu + xkp)^2 + ykp^2)^(3/2)) - ((3*mu + 3*xkp)*(ykp*((h^2*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + ((mu + xkp)*((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2))*(mu - 1) - mu*(((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)/((h^2 + 1)*((mu + xkp - 1)^2 + ykp^2)^(3/2)) - ((ykp*((h^2*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + (((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)*(mu + xkp - 1))/(h^2 + 1))*(3*mu + 3*xkp - 3))/((mu + xkp - 1)^2 + ykp^2)^(5/2)), 0, 0;...
    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0, 0, 0;...
    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0, 0, 0];


Uykp_mat = ...
    [(((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h^2*((3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1))/((mu + xkp)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h^2*((3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + ((mu + xkp)*((h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h^2*((3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2))*(mu - 1) - mu*(((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h^2*((3*mu*(mu + xk - 1)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - 3*yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2) - (3*(mu + xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - 3*yk^2))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1))/((mu + xkp - 1)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) + (((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp - 1))/(h^2 + 1)))/((mu + xkp - 1)^2 + ykp^2)^(5/2)), (mu - 1)*(((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 + (h*((h^2*((3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1))/((mu + xkp)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 + (h*((h^2*((3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) - ((mu + xkp)*((h^2*((3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2)) - mu*(((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 + (h*((h^2*((3*yk*(mu - 1)*(4*mu^2 + 8*mu*xk + 4*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(4*mu^2 + 8*mu*xk - 8*mu + 4*xk^2 - 8*xk - yk^2 + 4))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1))/((mu + xkp - 1)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + (((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)*(mu + xkp - 1))/(h^2 + 1)))/((mu + xkp - 1)^2 + ykp^2)^(5/2)), 0, 0;...
    (((h^2*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1))/((mu + xkp)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) + (((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2))*(mu - 1) - mu*(((h^2*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1))/((mu + xkp - 1)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) + (((h^3*((3*(mu + xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 4*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*(mu + xk - 1)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 4*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp - 1))/(h^2 + 1)))/((mu + xkp - 1)^2 + ykp^2)^(5/2)),                                                                                                                        (((h^2*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1))/((mu + xkp)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + ((mu + xkp)*((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2))*(mu - 1) - mu*(((h^2*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1))/((mu + xkp - 1)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - (h*((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + (((h^3*((3*yk*(mu - 1)*(3*mu^2 + 6*mu*xk + 3*xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) - (3*mu*yk*(3*mu^2 + 6*mu*xk - 6*mu + 3*xk^2 - 6*xk - 2*yk^2 + 3))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)*(mu + xkp - 1))/(h^2 + 1)))/((mu + xkp - 1)^2 + ykp^2)^(5/2)), 0, 0;...
    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        0, 0, 0;...
    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        0, 0, 0];

Uyxk_grad = Uyk_mat(1,:);
Uxxk_grad = Uxk_mat(1,:);

Uyyk_grad = Uyk_mat(2,:);
Uxyk_grad = Uxk_mat(2,:);

Uxxkp_grad = Uxkp_mat(1,:);
Uxykp_grad = Uxkp_mat(2,:);

Uyxkp_grad = Uykp_mat(1,:);
Uyykp_grad = Uykp_mat(2,:);

Uxxdkp_grad = Uxkp_mat(3,:);
Uxydkp_grad = Uxkp_mat(4,:);

%% calculate second derivatives of state dynamics (fij_grad row vectors)
f1x_grad = 1/(1+h2) * (-h3/2 * Uyxk_grad - h2/2*Uxxk_grad);
% f1x_grad = [ ((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)/(h^2 + 1), -((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)/(h^2 + 1), 0, 0];
f1y_grad = 1/(1+h2) *( -h3/2 * Uyyk_grad - h2/2*Uxyk_grad);
% f1y_grad = [ -((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)/(h^2 + 1), -((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2)/(h^2 + 1), 0, 0];
f1xd_grad = zeros(1,4);
f1yd_grad = zeros(1,4);

f2x_grad = -h*f1x_grad - h2/2*Uyxk_grad;
% f2x_grad = [ - (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1), (h*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1) - (h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2, 0, 0];
f2y_grad = -h*f1y_grad - h2/2*Uyyk_grad;
% f2y_grad = [ (h*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1) - (h^2*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2, (h^2*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1), 0, 0];
f2xd_grad = zeros(1,4);
f2yd_grad = zeros(1,4);

f3x_grad = 2*f2x_grad + h/2*f1x_grad - h/2 * Uxxkp_grad - h/2 * Uxxk_grad;
% f3x_grad = [ (h*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h*(mu*(((ykp*((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) - (((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp - 1))/(h^2 + 1))*(3*mu + 3*xkp - 3))/((mu + xkp - 1)^2 + ykp^2)^(5/2) + ((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)/((h^2 + 1)*((mu + xkp - 1)^2 + ykp^2)^(3/2))) - (((3*mu + 3*xkp)*(ykp*((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) - ((mu + xkp)*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2) + ((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)/((h^2 + 1)*((mu + xkp)^2 + ykp^2)^(3/2)))*(mu - 1)))/2 - h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))) - (3*h*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(2*(h^2 + 1)), (3*h*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(2*(h^2 + 1)) - (h*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 - h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)) - (h*(mu*(((ykp*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + (((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)*(mu + xkp - 1))/(h^2 + 1))*(3*mu + 3*xkp - 3))/((mu + xkp - 1)^2 + ykp^2)^(5/2) - ((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)/((h^2 + 1)*((mu + xkp - 1)^2 + ykp^2)^(3/2))) - (((3*mu + 3*xkp)*(ykp*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + ((mu + xkp)*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2) - ((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2)/((h^2 + 1)*((mu + xkp)^2 + ykp^2)^(3/2)))*(mu - 1)))/2, 0, 0];
f3y_grad = 2*f2y_grad + h/2*f1y_grad - h/2*Uxykp_grad - h/2*Uxyk_grad;
% f3y_grad = [ (3*h*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(2*(h^2 + 1)) - (h*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h*(mu*(((ykp*((h^2*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) + (((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp - 1))/(h^2 + 1))*(3*mu + 3*xkp - 3))/((mu + xkp - 1)^2 + ykp^2)^(5/2) - ((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)/((h^2 + 1)*((mu + xkp - 1)^2 + ykp^2)^(3/2))) - (((3*mu + 3*xkp)*(ykp*((h^2*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) + (((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2) - ((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)/((h^2 + 1)*((mu + xkp)^2 + ykp^2)^(3/2)))*(mu - 1)))/2 - h^2*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))), h^2*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)) - (h*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h*((((3*mu + 3*xkp)*(ykp*((h^2*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) - ((mu + xkp)*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2) + ((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2)/((h^2 + 1)*((mu + xkp)^2 + ykp^2)^(3/2)))*(mu - 1) - mu*(((ykp*((h^2*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) - (((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2)*(mu + xkp - 1))/(h^2 + 1))*(3*mu + 3*xkp - 3))/((mu + xkp - 1)^2 + ykp^2)^(5/2) + ((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2)/((h^2 + 1)*((mu + xkp - 1)^2 + ykp^2)^(3/2)))))/2 + (3*h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(2*(h^2 + 1)), 0, 0];
f3xd_grad = zeros(1,4);
f3yd_grad = zeros(1,4);

f4x_grad = -2*f1x_grad + h/2*f2x_grad - h/2*Uyxkp_grad - h/2*Uyxk_grad;
% f4x_grad = [ - (h*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (2*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1) - (h*((mu - 1)*(((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1))/((mu + xkp)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) - ((mu + xkp)*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2)) - mu*(((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1))/((mu + xkp - 1)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) + (((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp - 1))/(h^2 + 1)))/((mu + xkp - 1)^2 + ykp^2)^(5/2))))/2 - (h*((h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 + (h*((h^2*((mu*(4*mu + 4*xk - 4))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((4*mu + 4*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) + (5*(2*mu + 2*xk)*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2)) - (5*mu*(2*mu + 2*xk - 2)*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2 - (h^3*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)))/2, (2*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1) - (h*((((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1))/((mu + xkp)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) + ((mu + xkp)*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2))*(mu - 1) - mu*(((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1))/((mu + xkp - 1)^2 + ykp^2)^(3/2) + (3*ykp*(ykp*((h^2*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) - (((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2)*(mu + xkp - 1))/(h^2 + 1)))/((mu + xkp - 1)^2 + ykp^2)^(5/2))))/2 - (h*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h*((h^2*((2*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (2*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(2*mu^2 + 4*mu*xk + 2*xk^2 - yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(2*mu^2 + 4*mu*xk - 4*mu + 2*xk^2 - 4*xk - yk^2 + 2))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h^3*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/2, 0, 0];
f4y_grad = -2*f1y_grad + h/2*f2y_grad - h/2*Uyykp_grad - h/2*Uyyk_grad;
% f4y_grad = [ (2*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1) + (h*(mu*(((h^2*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1))/((mu + xkp - 1)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) + (((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp - 1))/(h^2 + 1)))/((mu + xkp - 1)^2 + ykp^2)^(5/2)) - (((h^2*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1))/((mu + xkp)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)) + (((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2)*(mu + xkp))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2))*(mu - 1)))/2 - (h*((h^2*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 - (h*((h^3*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2 + (h^2*((yk*(3*mu - 3))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (5*yk*(2*mu + 2*xk)*(3*mu - 3)*(mu + xk))/(2*((mu + xk)^2 + yk^2)^(7/2)) + (15*mu*yk*(2*mu + 2*xk - 2)*(mu + xk - 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2))))/2))/(h^2 + 1)))/2 - (h*((mu*(2*mu + 2*xk - 2))/((mu + xk - 1)^2 + yk^2)^(5/2) - ((2*mu + 2*xk)*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*mu*(2*mu + 2*xk - 2)*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/(2*((mu + xk - 1)^2 + yk^2)^(7/2)) + (5*(2*mu + 2*xk)*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/(2*((mu + xk)^2 + yk^2)^(7/2))))/2, (2*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1) - (h*(mu*(((h^2*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1))/((mu + xkp - 1)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) - (((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2)*(mu + xkp - 1))/(h^2 + 1)))/((mu + xkp - 1)^2 + ykp^2)^(5/2)) - (((h^2*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1))/((mu + xkp)^2 + ykp^2)^(3/2) - (3*ykp*(ykp*((h^2*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)) - ((mu + xkp)*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/((mu + xkp)^2 + ykp^2)^(5/2))*(mu - 1)))/2 + (h*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h*((h^2*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2 + (h*((h^2*(((3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(5/2) - (3*mu*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(5/2) + (15*mu*yk^2*(mu + xk - 1))/((mu + xk - 1)^2 + yk^2)^(7/2) - (5*yk^2*(3*mu - 3)*(mu + xk))/((mu + xk)^2 + yk^2)^(7/2)))/2 - (h^3*((4*mu*yk)/((mu + xk - 1)^2 + yk^2)^(5/2) - (4*yk*(mu - 1))/((mu + xk)^2 + yk^2)^(5/2) - (5*yk*(mu - 1)*(mu^2 + 2*mu*xk + xk^2 - 2*yk^2))/((mu + xk)^2 + yk^2)^(7/2) + (5*mu*yk*(mu^2 + 2*mu*xk - 2*mu + xk^2 - 2*xk - 2*yk^2 + 1))/((mu + xk - 1)^2 + yk^2)^(7/2)))/2))/(h^2 + 1)))/2, 0, 0];
f4xd_grad = zeros(1,4);
f4yd_grad = zeros(1,4);

%% GAUSS JORDAN TERMS
% define gauss-jordan terms a,b,c,d,e,f,g
a_grad = -f1y_grad*1/f1x + 1/(f1x*f1x)*f1x_grad*f1y;
b_grad = -f1xd_grad*1/f1x + 1/(f1x*f1x)*f1x_grad * f1xd;
c_grad = -f1yd_grad*1/f1x + 1/(f1x*f1x)*f1x_grad*f1yd;
e_grad = -((f2xd_grad + b_grad*f2x + f2x_grad*b)*1/(f2y+a*f2x) ...
    - 1/(f2y+a*f2x)^2 *(f2y_grad + a_grad*f2x + f2x_grad*a)*(f2xd+b*f2x));
f_grad = -((f2yd_grad + c_grad*f2x + f2x_grad*c)*1/(f2y+a*f2x) ...
    - 1/(f2y+a*f2x)^2*(f2y_grad + a_grad*f2x + f2x_grad*a) *(f2yd+c*f2x));

g_grad = -((f3yd_grad + f3x_grad *c + c_grad*f3x + f_grad*f3y +f3y_grad*f ...
    + f_grad*a*f3x + a_grad*f*f3x + f3x_grad*f*a)*1/(f3xd + b*f3x + e*(f3y + a*f3x)) ...
    - 1/(f3xd + b*f3x + e*(f3y + a*f3x))^2 * ( f3xd_grad + b_grad*f3x + ...
    f3x_grad*b + e_grad*f3y + f3y_grad*e + e_grad*a*f3x + a_grad*e*f3x + f3x_grad * e*a)*(f3yd + c*f3x + f*(f3y + a*f3x)) );

% partial of beta (terms generated by the gauss-jordan elimination used in
% the costate dynamics)
% these gradients are all 1x4 row vectors
beta1_grad = zeros(1,4);
beta2_grad = a_grad*hxk;
beta3_grad = b_grad*hxk + e_grad*hyk + e*a_grad*hxk + e_grad*a*hxk;
beta4_grad = c_grad*hxk + f_grad*hyk + f_grad*a*hxk + a_grad*f*hxk + g_grad*hxdk ...
    + g_grad*b*hxk + b_grad*g*hxk + g_grad*e*hyk + e_grad*g*hyk + g_grad*e*a*hxk ...
    + e_grad*g*a*hxk + a_grad*g*e*hxk;

beta4_hgrad = [c+f*a+g*b+g*e*a,f+g*e,g,1];
beta3_hgrad = [b+e*a,e,1,0];
beta2_hgrad = [a,1,0,0];
beta1_hgrad = [1,0,0,0];

% need gradient of alpha terms (gauss jordan terms)
a11_grad = f1x_grad;
a12_grad = f2x_grad;
a13_grad = f3x_grad;
a14_grad = f4x_grad;

a22_grad = f2y_grad + a_grad*f2x + a*f2x_grad;
a23_grad = f3y_grad + a_grad*f3x + a*f3x_grad;
a24_grad = f4y_grad + a_grad*f4x + a*f4x_grad;

a33_grad = f3xd_grad + b_grad*f3x + b*f3x_grad + e_grad*f3y + e*f3y_grad ...
    + e_grad*a*f3x + a_grad*e*f3x + f3x_grad * e*a;
a34_grad = f4xd_grad + b_grad*f4x + b*f4x_grad + e_grad*f4y + e*f4y_grad ...
    + e_grad*a*f4x + a_grad*e*f4x + f4x_grad*e*a;

a44_grad = f4yd_grad + c_grad*f4x + c*f4x_grad + f_grad*f4y + f*f4y_grad ...
    + f_grad*a*f4x + a_grad *f*f4x + f4x_grad*f*a + g_grad*f4xd + g*f4xd_grad ...
    + g_grad*b*f4x + b_grad*g*f4x + f4x_grad*g*b + g_grad*e*f4y + e_grad*g*f4y ...
    + f4y_grad*g*e + g_grad*a*e*f4x + a_grad*g*e*f4x + e_grad*a*g*f4x + f4x_grad*a*g*e;

%% partials of the costate equations of motion
g4_grad = 1/a44*beta4_grad - 1/a44^2*a44_grad * beta4;

g3_grad = 1/a33 *beta3_grad - 1/a33^2 *beta3*a33_grad - 1/a33*a34_grad * g4 ...
    + 1/a33^2*a33_grad*a34*g4 - g4_grad*a34/a33;

g2_grad = 1/a22*beta2_grad - 1/a22^2*a22_grad*beta2 - a23_grad * 1/a22*g3 ...
    + 1/a22^2*a22_grad*a23*g3 - g3_grad*a23/a22 - a24_grad*1/a22*g4 ...
    + 1/a22^2*a22_grad*a24*g4 - g4_grad*a24/a22;

g1_grad = 1/a11*beta1_grad - 1/a11^2*a11_grad*beta1 - g2/a11*a12_grad ...
    - g2_grad*a12*a11 + 1/a11^2*a11_grad*a12*g2 - a13_grad*g3/a11 + 1/a11^2*a11_grad*a13*g3 ...
    -a13/a11*g3_grad - a14_grad*1/a11*g4 +1/a11^2*a11_grad*a14*g4 - a14/a11*g4_grad;

dgdx = [g1_grad;g2_grad;g3_grad;g4_grad];


%% partial of the state equations with respect to the costate (dfdh)

f1_hgrad = zeros(1,4);
f2_hgrad = zeros(1,4);
f3_hgrad = zeros(1,4);
f3_hgrad(3) = -h*um*hydk^2/((hxdk^2+hydk^2)^1.5);
f3_hgrad(4) = h*um*hydk*hxdk/((hxdk^2+hydk^2)^1.5);


f4_hgrad = zeros(1,4);
f4_hgrad(3) = h*um*hydk*hxdk/((hxdk^2+hydk^2)^1.5);
f4_hgrad(4) = -h*um*hxdk^2/((hxdk^2+hydk^2)^1.5);

dfdh = [f1_hgrad;f2_hgrad;f3_hgrad;f4_hgrad];

%% partials of the costate equations wrt costate (dgdh)


g4_hgrad = 1/a44*beta4_hgrad;
g3_hgrad = beta3_hgrad*1/a33-a34/a22*g4_hgrad;
g2_hgrad = beta2_hgrad*1/a22-a23/a22*g3_hgrad-a24/a22*g4_hgrad;
g1_hgrad = beta1_hgrad*1/a11 - a12/a11*g2_hgrad-a13/a11*g3_hgrad-a14*g4_hgrad;

dgdh = [g1_hgrad;g2_hgrad;g3_hgrad;g4_hgrad];